name: Build and Release Swift (Full Tweak Build)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "URL to the decrypted Spotify IPA file"
        default: ""
        required: true
        type: string

env:
  SWIFTPROTOBUF_VERSION: "1.29.0"

jobs:
  build:
    runs-on: macos-latest
    env:
      THEOS: ${{ github.workspace }}/theos
    steps:
    - uses: actions/checkout@v4
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2.0'

    - name: Setup Theos
      uses: actions/checkout@v4
      with:
         repository: theos/theos
         path: ${{ github.workspace }}/theos
         submodules: recursive

    - name: Install Dependencies
      run: |
        brew install make dpkg ldid
        echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

    - name: Copy SwiftProtobuf (rootful)
      run: |
        mkdir swiftprotobuf && cd "$_"
        wget https://github.com/whoeevee/swift-protobuf/releases/download/${{ env.SWIFTPROTOBUF_VERSION }}/org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm.deb
        ar -x org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm.deb
        tar -xvf data.tar.lzma
        cp -r Library/Frameworks/SwiftProtobuf.framework $THEOS/lib

    - name: Copy SwiftProtobuf (rootless)
      run: |
        mkdir swiftprotobuf-rootless && cd "$_"
        wget https://github.com/whoeevee/swift-protobuf/releases/download/${{ env.SWIFTPROTOBUF_VERSION }}/org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm64.deb
        ar -x org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm64.deb
        tar -xvf data.tar.lzma
        cp -r var/jb/Library/Frameworks/SwiftProtobuf.framework $THEOS/lib/iphone/rootless

    - name: Build EeveeSpotify (rootful)
      run: |
        make package FINALPACKAGE=1
        echo "filename=$(find . -not -name '*debug*' -path './packages/*' | cut -d/ -f3)" >> $GITHUB_ENV
    - uses: actions/upload-artifact@v4
      with:
        name: ${{env.filename}}
        path: packages/${{env.filename}}
        if-no-files-found: error

    - name: Build EeveeSpotify (rootless)
      run: |
        make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless
        echo "filename=$(find . -name '*arm64*' -path './packages/*' | cut -d/ -f3)" >> $GITHUB_ENV
    - uses: actions/upload-artifact@v4
      with:
        name: ${{env.filename}}
        path: packages/${{env.filename}}
        if-no-files-found: error

  release:
    needs: build
    permissions:
        contents: write
    runs-on: macos-latest
    defaults:
      run:
        shell: zsh {0}
    steps:
    - uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true

    - name: Set EeveeSpotify Versions
      run: |
        # Annahme: Nur eine .deb-Datei mit arm im Namen
        EEVEESPOTIFY_ROOTFUL=$(echo *iphoneos-arm.deb)
        EEVEESPOTIFY_ROOTLESS=$(echo *iphoneos-arm64.deb)
        # Extrahiere die Version (z.B. 6.1.6 aus com.eevee.spotify_6.1.6_iphoneos-arm64.deb)
        EEVEESPOTIFY_VERSION=$(echo "$EEVEESPOTIFY_ROOTFUL" | cut -d'_' -f2)

        echo "EEVEESPOTIFY_ROOTFUL=$EEVEESPOTIFY_ROOTFUL" >> $GITHUB_ENV
        echo "EEVEESPOTIFY_ROOTLESS=$EEVEESPOTIFY_ROOTLESS" >> $GITHUB_ENV
        echo "EEVEESPOTIFY_VERSION=$EEVEESPOTIFY_VERSION" >> $GITHUB_ENV

    - name: Download SwiftProtobuf
      run: |
        wget https://github.com/whoeevee/swift-protobuf/releases/download/${{ env.SWIFTPROTOBUF_VERSION }}/org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm.deb
        wget https://github.com/whoeevee/swift-protobuf/releases/download/${{ env.SWIFTPROTOBUF_VERSION }}/org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm64.deb

        echo "SWIFTPROTOBUF_ROOTFUL=org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm.deb" >> $GITHUB_ENV
        echo "SWIFTPROTOBUF_ROOTLESS=org.swift.protobuf.swiftprotobuf_${{ env.SWIFTPROTOBUF_VERSION }}_iphoneos-arm64.deb" >> $GITHUB_ENV

    - name: Download OpenSpotifySafariExtension
      run: |
        git clone https://github.com/BillyCurtis/OpenSpotifySafariExtension
        echo "OPENSPOTIFYSAFARIEXTENSION=OpenSpotifySafariExtension/OpenSpotifySafariExtension.appex" >> $GITHUB_ENV

    # HIER WIRD DER BENUTZEREINGABE-LINK VERWENDET
    - name: Download Decrypted Spotify Package (User Input)
      run: |
        # Download des IPA-Pakets von der User-URL
        wget "${{ inputs.ipa_url }}" --no-verbose -O spotify_decrypted.ipa
        echo "SPOTIFY_PACKAGE=spotify_decrypted.ipa" >> $GITHUB_ENV
        
        # Extrahieren des Namens zur Versionsbestimmung für den Release
        SPOTIFY_FILENAME_NO_EXT=$(basename "${{ inputs.ipa_url }}" .ipa)
        # Versucht, die Versionsnummer aus dem Dateinamen zu extrahieren, falls vorhanden (z.B. Spotify-8.8.84.ipa)
        SPOTIFY_VERSION=$(echo "$SPOTIFY_FILENAME_NO_EXT" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | tail -1)
        
        # Fallback, falls keine Version gefunden
        if [ -z "$SPOTIFY_VERSION" ]; then
            SPOTIFY_VERSION="unknown"
        fi
        
        echo "SPOTIFY_VERSION=$SPOTIFY_VERSION" >> $GITHUB_ENV

    - name: Setup insert-dylib
      run: |
        git clone https://github.com/Tyilo/insert_dylib.git
        xcrun clang -x c -arch arm64 ./insert_dylib/insert_dylib/main.c -I/usr/include/ -o insert-dylib
        sudo mv insert-dylib /usr/local/bin/
        sudo chmod +x /usr/local/bin/insert-dylib

    - name: Setup ivinject
      run: |
        git clone https://github.com/whoeevee/ivinject.git
        cp -r ./ivinject/KnownFrameworks ~/.ivinject
        wget https://github.com/whoeevee/ivinject/releases/download/first/ivinject-arm64
        sudo mv ivinject-arm64 /usr/local/bin/
        sudo chmod +x /usr/local/bin/ivinject-arm64

    - name: Setup ipapatch
      run: |
        wget https://github.com/asdfzxcvbn/ipapatch/releases/download/v2.1.0/ipapatch.macos-arm64
        sudo mv ipapatch.macos-arm64 /usr/local/bin/ipapatch
        sudo chmod +x /usr/local/bin/ipapatch

    - name: Check Version
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Starkes Token verwenden
      run: |
        LATEST_EEVEESPOTIFY_VERSION=$(gh release list --limit 1 --json tagName --jq '.[0].tagName | ltrimstr("swift")') # Passt den Parsen-Befehl an das neue Tag-Format an
        echo "LATEST_EEVEESPOTIFY_VERSION=$LATEST_EEVEESPOTIFY_VERSION" >> $GITHUB_ENV

    - name: Create EeveeSpotify Package
      run: |
        # Wir verwenden die lokal gebaute .deb ($EEVEESPOTIFY_ROOTFUL)
        EEVEESPOTIFY_PACKAGE="EeveeSpotify-${EEVEESPOTIFY_VERSION}-${SPOTIFY_VERSION}.ipa"
        echo "EEVEESPOTIFY_PACKAGE=$EEVEESPOTIFY_PACKAGE" >> $GITHUB_ENV

        ivinject-arm64 "$SPOTIFY_PACKAGE" "$EEVEESPOTIFY_PACKAGE" \
          -i "$EEVEESPOTIFY_ROOTFUL" "$SWIFTPROTOBUF_ROOTFUL" "$OPENSPOTIFYSAFARIEXTENSION" \
          -s - -d --level Optimal

    - name: Create Patched Package
      run: |
        EEVEESPOTIFY_PATCHED_PACKAGE="EeveeSpotify-${EEVEESPOTIFY_VERSION}-${SPOTIFY_VERSION}-patched.ipa"
        echo "EEVEESPOTIFY_PATCHED_PACKAGE=$EEVEESPOTIFY_PATCHED_PACKAGE" >> $GITHUB_ENV

        ipapatch -input "$EEVEESPOTIFY_PACKAGE" -output "$EEVEESPOTIFY_PATCHED_PACKAGE"

    - name: Compose Changelog
      if: env.LATEST_EEVEESPOTIFY_VERSION != env.EEVEESPOTIFY_VERSION
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }} # Starkes Token verwenden
      run: |
        # ... (Unveränderter Changelog-Code)
        last_update_repo_date=$(git log --grep="bump" --format=%cI | sed -n 2p)
        CHANGELOG=""

        gh pr list --state merged --search "merged:>${last_update_repo_date}" --json files,author \
          | jq -r '
              .[]
              | .author.login as $login
              | .files[0].path as $file
              | "\($login) \($file)"
            ' \
          | tail -r \
          | while read -r login file; do
              lang_code=$(echo "$file" | grep -oE '/([a-zA-Z-]+)\.lproj/' | sed -E 's|/([a-zA-Z-]+)\.lproj/|\1|')
              lang_name=$(echo "import Foundation; print(Locale.current.localizedString(forIdentifier: \"$lang_code\") ?? \"\")" | swift -)

              if [ -z "$lang_name" ]; then
                continue
              fi

              CHANGELOG+="* Updated ${lang_name} localization by @${login}"$'\n'
            done

        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$CHANGELOG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Create Release
      if: env.LATEST_EEVEESPOTIFY_VERSION != env.EEVEESPOTIFY_VERSION
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # KORREKTUR: Starkes Token verwenden
      with:
        tag_name: swift${{ env.EEVEESPOTIFY_VERSION }}
        release_name: Swift ${{ env.EEVEESPOTIFY_VERSION }} (Spotify ${{ env.SPOTIFY_VERSION }})
        body: ${{ env.CHANGELOG }}
        draft: false
        prerelease: false

    - name: Upload Packages (DEB und IPA)
      env:
        GH_TOKEN: ${{ secrets.RELEASE_TOKEN }} # KORREKTUR: Starkes Token verwenden
      run: |
        # IPA-Pakete (die eigentliche App) hochladen
        gh release upload "swift$EEVEESPOTIFY_VERSION" \
          "$EEVEESPOTIFY_PACKAGE" "$EEVEESPOTIFY_PATCHED_PACKAGE" \
          --clobber

        # DEB-Pakete (für Jailbreaker/Entwickler) hochladen
        gh release upload "swift$EEVEESPOTIFY_VERSION" \
          "$EEVEESPOTIFY_ROOTFUL" "$EEVEESPOTIFY_ROOTLESS" \
          "$SWIFTPROTOBUF_ROOTFUL" "$SWIFTPROTOBUF_ROOTLESS" \
          --clobber

